<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Artemis Skys</title>
  <style>
    :root{
      --space:#2a2a2a; --space-2:#1e1e1e; --card:#333333;
      --text:#f2f2f2; --muted:#b5b5b5; --accent:#9a9a9a; --accent-2:#c2c2c2;
      --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --radius:16px; --shadow:0 14px 40px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text);
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.35)), url('https://upload.wikimedia.org/wikipedia/commons/0/02/FullMoon2010.jpg') center/cover no-repeat fixed;
      background-size: 110% auto;
    }
    .sky{position:fixed; inset:0; z-index:-1; pointer-events:none;
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.35)), url('https://upload.wikimedia.org/wikipedia/commons/0/02/FullMoon2010.jpg') center/cover no-repeat fixed;
      filter: brightness(.55);
    }
    a{color:var(--accent)}
    header{position:sticky; top:0; z-index:20; background:rgba(34,34,34,.88); backdrop-filter: blur(10px); border-bottom:1px solid rgba(255,255,255,.08)}
    .wrap{max-width:1100px; margin:0 auto; padding:16px}
    .row{display:flex; align-items:center; gap:12px}
    .spacer{flex:1}
    nav a{margin:0 10px; text-decoration:none; color:var(--text); opacity:.9}
    nav a.active{color:var(--accent-2)}
    .btn{background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#1a1a1a; border:0; padding:10px 14px; border-radius:12px; font-weight:700; box-shadow: var(--shadow); cursor:pointer; transition: transform .12s ease, box-shadow .2s ease}
    .btn:hover{transform:translateY(-1px); box-shadow: 0 0 0 2px rgba(255,255,255,.18), 0 16px 40px rgba(0,0,0,.25)}
    .btn.secondary{background:#444; color:var(--text); box-shadow:none; border:1px solid rgba(255,255,255,.12)}
    .btn.ghost{background:transparent; border:1px solid rgba(255,255,255,.15); color:var(--text)}
    .btn.small{padding:6px 10px; border-radius:10px; font-size:.9rem}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px}
    .logo svg{width:34px; height:34px}
    .brand-logo{height:34px; width:auto; border-radius:8px; display:none}
    .logo span{color:var(--accent-2)}
    .hero{padding:64px 16px 24px}
    .hero h1{font-size:clamp(28px, 6vw, 48px); margin:0 0 10px; line-height:1.05; color:var(--text)}
    .hero p{max-width:720px; color:var(--muted); font-size:1.03rem}
    .cards{display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:16px; margin:26px 0}
    .card{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
    .card.clickable{cursor:pointer; transition:transform .12s ease, box-shadow .2s ease}
    .card.clickable:hover{transform:translateY(-1px); box-shadow: 0 0 0 2px rgba(255,255,255,.18), 0 16px 40px rgba(0,0,0,.25)}
    .muted{color:var(--muted)}
    .two-col{display:grid; grid-template-columns:1.2fr .8fr; gap:18px}
    @media (max-width:900px){.two-col{grid-template-columns:1fr}}
    .panel{background:var(--card); border:1px solid rgba(255,255,255,.1); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow)}
    .field{display:flex; gap:10px; margin:8px 0; align-items:center}
    .field input,.field select,.field textarea{background:#222; color:var(--text); border:1px solid rgba(255,255,255,.15); border-radius:12px; padding:10px 12px; width:100%}
    .field label{min-width:120px; color:var(--muted)}
    .help{font-size:.9rem; color:var(--muted); margin-top:6px}
    table{width:100%; border-collapse:collapse; font-size:.95rem}
    th,td{border-bottom:1px solid rgba(255,255,255,.1); padding:10px; text-align:left}
    th{color:#f5f5f5; font-weight:800}
    tr:hover td{background:rgba(255,255,255,.05)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.15); cursor:pointer; background:rgba(50,50,50,.7)}
    .tab.active{border-color:transparent; background:linear-gradient(135deg, rgba(120,120,120,.45), rgba(170,170,170,.45))}
    .hidden{display:none}
    .right{justify-content:flex-end}
    .notice{font-size:.95rem; color:var(--muted)}
    .tag{border:1px solid rgba(255,255,255,.2); border-radius:999px; padding:4px 8px; font-size:.8rem; color:var(--muted); background:rgba(50,50,50,.7)}
    footer{opacity:.85; padding:44px 16px; text-align:center; color:var(--muted)}
    .banner{border:1px solid rgba(245,158,11,.5); background:rgba(245,158,11,.15); color:#fde68a; border-radius:var(--radius); padding:10px 12px; margin:8px 0}
    .topbar{display:flex; align-items:center; gap:10px; margin-bottom:10px}
  </style>
</head>
<body>
  <div class="sky" aria-hidden="true"></div>

  <header>
    <div class="wrap row">
      <div class="logo" id="go-home" style="cursor:pointer">
        <img id="brand-logo" class="brand-logo" alt="Logo"/>
        <svg id="fallback-logo" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#bbbbbb"/><stop offset="100%" stop-color="#e0e0e0"/>
          </linearGradient></defs>
          <path d="M40 10a16 16 0 1 0 14 24A18 18 0 1 1 40 10Z" fill="url(#g)"/>
          <path d="M16 44c0-5.523 4.477-10 10-10a9.98 9.98 0 0 1 7.14 2.96A12 12 0 1 1 46 52H20a8 8 0 0 1-8-8Z" fill="#e5e7eb" opacity=".9"/>
        </svg>
        <span id="brand-name">Artemis Skys</span>
      </div>
      <nav class="spacer">
        <a href="#home" data-nav>Home</a>
        <a href="#about" data-nav>About</a>
        <a href="#more" data-nav>More Info</a>
        <a href="#host" data-nav>For Companies</a>
        <a href="#menu" id="nav-menu" class="hidden">Menu</a>
      </nav>

      <div class="row right" id="auth-buttons">
        <button class="btn small" id="btn-login">Log in</button>
        <button class="btn ghost small" id="btn-signup">Sign up</button>
      </div>

      <div class="row right hidden" id="user-badge">
        <span class="tag" id="whoami">Signed in</span>
        <button class="btn secondary small" id="btn-logout">Log out</button>
        <button class="btn ghost small hidden" id="resend-verify">Resend verification</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- LANDING -->
    <section id="home" class="hero">
      <h1>Scheduling & Inventory that feels calm and reliable.</h1>
      <p>Post-login menu lets you jump into <strong>Scheduling</strong> or <strong>Inventory</strong>. Employees see Scheduling only. Admins can brand the app with your company name, logo, and background.</p>
      <div class="row" style="margin-top:18px; gap:12px">
        <button class="btn" id="cta-get-started">Get Started</button>
        <button class="btn secondary" id="cta-learn">Learn More</button>
      </div>
      <div class="cards">
        <div class="card"><h3>Email Link Sign-in</h3><p class="muted">No passwords needed for employees.</p></div>
        <div class="card"><h3>Per-employee View</h3><p class="muted">“My Shifts” + optional “All Schedules”.</p></div>
        <div class="card"><h3>Branding</h3><p class="muted">Set company name, logo, and background.</p></div>
      </div>
    </section>

    <section id="about" class="hero hidden">
      <h1>About Artemis Skys</h1>
      <p>Multi-user portal for <strong>shifts</strong> and <strong>stock</strong>. Firestore-backed scheduling; local inventory.</p>
    </section>

    <section id="more" class="hero hidden">
      <h1>More Info</h1>
      <div class="cards">
        <div class="card"><h3>Data Portability</h3><p class="muted">Inventory export/import as JSON/CSV.</p></div>
        <div class="card"><h3>Privacy</h3><p class="muted">Only admins can edit schedules.</p></div>
        <div class="card"><h3>Extensibility</h3><p class="muted">Add PTO, approvals, SMS, more.</p></div>
      </div>
    </section>

    <section id="host" class="hero hidden">
      <h1>For Companies</h1>
      <div class="panel">
        <strong>Quick Start</strong>
        <ol>
          <li>Sign up your admin account, verify email.</li>
          <li>Invite employees (email link sign-in).</li>
          <li>Set your brand name, logo, and background in the Menu page.</li>
        </ol>
      </div>
    </section>

    <!-- AUTH -->
    <section id="auth" class="hero hidden">
      <div id="auth-banner" class="banner hidden">If you can’t log in, make sure your domain is in Firebase Auth <em>Authorized domains</em> and Email/Password + Email Link methods are enabled.</div>
      <div class="two-col">
        <div class="panel">
          <h3>Log in</h3>
          <div class="field"><label>Email</label><input id="login-email" type="email" placeholder="you@company.com"/></div>
          <div class="field"><label>Password</label><input id="login-pass" type="password" placeholder="••••••••"/></div>
          <div class="row right" style="gap:8px; flex-wrap:wrap">
            <button class="btn secondary" id="forgot-pass">Forgot password</button>
            <button class="btn" id="do-login">Enter</button>
            <button class="btn ghost" id="login-magic" title="Send yourself a sign-in link">Email me a sign-in link</button>
          </div>
          <p class="help">Employees without a password can use the email link option.</p>
        </div>
        <div class="panel">
          <h3>Sign up (Admin)</h3>
          <div class="field"><label>Name</label><input id="su-name" type="text" placeholder="Full name"/></div>
          <div class="field"><label>Email</label><input id="su-email" type="email" placeholder="you@company.com"/></div>
          <div class="field"><label>Password</label><input id="su-pass" type="password" placeholder="At least 6 chars"/></div>
          <div class="row right"><button class="btn secondary" id="do-signup">Create Account</button></div>
          <p class="help">First account becomes admin automatically.</p>
        </div>
      </div>
    </section>

    <!-- RESET PASSWORD -->
    <section id="reset" class="hero hidden">
      <div class="panel">
        <h3>Reset your password</h3>
        <p class="help">For: <strong id="rp-email">your email</strong></p>
        <div class="field"><label>New password</label><input id="rp-pass1" type="password" placeholder="At least 6 characters"/></div>
        <div class="field"><label>Confirm password</label><input id="rp-pass2" type="password" placeholder="Repeat password"/></div>
        <div class="row right" style="gap:8px">
          <button class="btn secondary" id="rp-cancel">Cancel</button>
          <button class="btn" id="rp-submit">Set New Password</button>
        </div>
      </div>
    </section>

    <!-- APP -->
    <section id="app" class="hero hidden">
      <div id="warn" class="banner hidden">Limited mode: Firestore rules may be blocking reads/writes. Check your Firestore Security Rules.</div>

      <!-- MENU PAGE -->
      <div id="page-menu">
        <div class="topbar">
          <h2 style="margin:0">Menu</h2>
          <div class="spacer"></div>
          <div class="tag" id="session-user">User</div>
        </div>
        <div class="cards" id="menu-cards">
          <div class="card clickable" id="menu-schedule"><h3>Scheduling</h3><p class="muted">Create, assign, and view shifts.</p></div>
          <div class="card clickable" id="menu-inventory"><h3>Inventory</h3><p class="muted">Track items and stock changes.</p></div>
        </div>

        <!-- Admin-only branding panel -->
        <div id="brand-panel" class="panel hidden" style="margin-top:14px">
          <h3>Branding</h3>
          <div class="two-col">
            <div>
              <div class="field"><label>Company name</label><input id="brand-name-input" placeholder="Your Company"/></div>
              <div class="field"><label>Logo URL</label><input id="brand-logo-input" placeholder="https://.../logo.png"/></div>
              <div class="field"><label>Background URL</label><input id="brand-bg-input" placeholder="https://.../background.jpg"/></div>
              <div class="field"><label>Default Start</label><input id="brand-default-start" type="time" value="09:00"/></div>
              <div class="field"><label>Default End</label><input id="brand-default-end" type="time" value="17:00"/></div>
              <div class="row right"><button class="btn small" id="save-brand">Save Branding</button></div>
              <p class="help">Tip: Use a large landscape image for the background for best results.</p>
            </div>
            <div>
              <div class="card"><h4 style="margin:0 0 6px">Preview</h4>
                <div class="row" style="align-items:center; gap:10px">
                  <img id="brand-logo-preview" class="brand-logo" style="display:block"/>
                  <span id="brand-name-preview" style="font-weight:800">Your Company</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SCHEDULE PAGE -->
      <div id="page-schedule" class="hidden">
        <div class="topbar">
          <button class="btn ghost small" id="btn-back-schedule">← Back to Menu</button>
          <h2 style="margin:0">Scheduling</h2>
          <div class="spacer"></div>
          <div class="tag" id="session-user-sched">User</div>
        </div>

        <div id="admin-only" class="two-col">
          <div class="panel">
            <h3>Employees</h3>
            <div class="field"><label>Name</label><input id="emp-name" placeholder="Employee name"/></div>
            <div class="field"><label>Email</label><input id="emp-email" type="email" placeholder="person@company.com"/></div>
            <div class="row right" style="gap:8px; flex-wrap:wrap">
              <button class="btn small" id="invite-emp">Invite by Email Link</button>
              <button class="btn secondary small" id="add-emp">Add without sending</button>
            </div>
            <p class="help">Invites send a passwordless sign-in link.</p>
            <table id="emp-table" style="margin-top:10px">
              <thead><tr><th>Name</th><th>Email</th><th>Subscribed</th><th>Action</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="panel">
            <h3>New Shift</h3>
            <div class="field"><label>Date</label><input id="shift-date" type="date"/></div>
            <div class="field"><label>Employee</label><select id="shift-emp"></select></div>
            <div class="field"><label>Start</label><input id="shift-start" type="time"/></div>
            <div class="field"><label>End</label><input id="shift-end" type="time"/></div>
            <div class="field"><label>Email Update</label><input id="shift-email-update" type="checkbox" checked/></div>
            <div class="row right"><button class="btn" id="add-shift">Add Shift</button></div>
          </div>
        </div>

        <div id="employee-only" class="panel hidden">
          <h3>My Preferences</h3>
          <div class="field"><label>Email me updates</label><input id="me-subscribed" type="checkbox"/></div>
          <p class="help">You’ll receive an email when new shifts are posted.</p>
        </div>

        <div class="panel" style="margin-top:16px">
          <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap">
            <div class="tabs" id="view-tabs">
              <div class="tab" data-scope="mine">My Shifts</div>
              <div class="tab" data-scope="all">All Schedules</div>
            </div>
            <div class="spacer"></div>
            <input id="week-start" type="date"/>
            <button class="btn small" id="refresh-week">Refresh</button>
          </div>
          <div style="overflow:auto; margin-top:10px">
            <table id="week-table">
              <thead id="week-head"></thead>
              <tbody id="week-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- INVENTORY PAGE -->
      <div id="page-inventory" class="hidden">
        <div class="topbar">
          <button class="btn ghost small" id="btn-back-inventory">← Back to Menu</button>
          <h2 style="margin:0">Inventory</h2>
          <div class="spacer"></div>
          <div class="tag" id="session-user-inv">User</div>
        </div>

        <div class="two-col">
          <div class="panel">
            <h3>Add / Edit Item</h3>
            <div class="field"><label>Name</label><input id="inv-name" placeholder="Item name"/></div>
            <div class="field"><label>SKU</label><input id="inv-sku" placeholder="SKU-123"/></div>
            <div class="field"><label>Qty</label><input id="inv-qty" type="number" placeholder="0"/></div>
            <div class="field"><label>Unit Cost</label><input id="inv-cost" type="number" step="0.01" placeholder="0.00"/></div>
            <div class="row right"><button class="btn" id="save-item">Save Item</button></div>
          </div>
          <div class="panel">
            <h3>Adjust Stock</h3>
            <div class="field"><label>SKU</label><input id="adj-sku" placeholder="SKU-123"/></div>
            <div class="field"><label>Change</label><input id="adj-delta" type="number" placeholder="e.g. +5 or -2"/></div>
            <div class="row right" style="gap:8px">
              <button class="btn small" id="receive">Receive (+)</button>
              <button class="btn secondary small" id="issue">Issue (-)</button>
            </div>
          </div>
        </div>
        <div class="panel" style="margin-top:16px">
          <div class="row" style="gap:8px; align-items:center">
            <h3 style="margin:0">Inventory</h3>
            <div class="spacer"></div>
            <button class="btn ghost small" id="export-inv">Export CSV</button>
          </div>
          <div style="overflow:auto; margin-top:10px">
            <table id="inv-table">
              <thead><tr><th>Name</th><th>SKU</th><th>Qty</th><th>Unit Cost</th><th>Value</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="panel" style="margin-top:16px">
          <h3>Audit Log</h3>
          <table id="log-table">
            <thead><tr><th>When</th><th>SKU</th><th>Delta</th><th>Note</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <footer>© <span id="year"></span> Artemis Skys. All rights reserved.</footer>

  
  <!-- ===== Fallback auth openers (run before Firebase JS) ===== -->
  <script>
    // Ensure the header "Log in" and "Sign up" buttons always open the auth panel,
    // even if the Firebase module hasn't finished loading yet.
    (function(){
      const loginBtn = document.getElementById('btn-login');
      const signupBtn = document.getElementById('btn-signup');
      function openAuth(){ try{ window.showSection && window.showSection('auth'); setTimeout(()=>{ document.getElementById('login-email')?.focus(); }, 0); }catch{} }
      if (loginBtn) loginBtn.addEventListener('click', (e)=>{ e.preventDefault(); openAuth(); }, { once:false });
      if (signupBtn) signupBtn.addEventListener('click', (e)=>{ e.preventDefault(); openAuth(); }, { once:false });
    })();
  </script>

  
  <!-- ===== Early login triggers (before Firebase) ===== -->
  <script>
    (function(){
      function queueLogin(){
        try {
          const email = document.getElementById('login-email')?.value?.trim() || '';
          const pass  = document.getElementById('login-pass')?.value || '';
          if (window._doLogin) { window._doLogin(email, pass); }
          else { window._pendingLogin = { email, pass }; }
        } catch {}
      }
      function onEnter(e){
        if (e.key === 'Enter') {
          e.preventDefault();
          queueLogin();
        }
      }
      const btn = document.getElementById('do-login');
      const em  = document.getElementById('login-email');
      const pw  = document.getElementById('login-pass');
      if (btn) btn.addEventListener('click', (e)=>{ e.preventDefault(); queueLogin(); });
      if (em)  em.addEventListener('keydown', onEnter);
      if (pw)  pw.addEventListener('keydown', onEnter);
    })();
  </script>

  <!-- ========= App utilities (inventory local) ========= -->
  <script>
    const DEFAULT_BG = 'https://upload.wikimedia.org/wikipedia/commons/0/02/FullMoon2010.jpg';
    const $ = sel => document.querySelector(sel);
    const $$ = sel => [...document.querySelectorAll(sel)];
    const fmtDate = d => new Date(d).toLocaleString([], {year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    const weekStartISO = () => {
      const d = new Date();
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      const monday = new Date(d.setDate(diff));
      return monday.toISOString().slice(0,10);
    };
    const store = {
      get(k, fallback){ try{ return JSON.parse(localStorage.getItem(k) ?? JSON.stringify(fallback)); }catch{ return fallback } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
    };
    const K = { inv: 'as_inv', log: 'as_inv_log' };

    // Section nav
    function showSection(id){
      ['home','about','more','host','auth','reset','app'].forEach(s=>{
        const el = document.getElementById(s);
        if(!el) return; el.classList.toggle('hidden', s!==id);
      });
      $$('nav a[data-nav]').forEach(a=>{
        const tgt = a.getAttribute('href').replace('#','');
        a.classList.toggle('active', tgt===id);
      })
    }
    window.showSection = showSection;

    // In-app pages
    function showAppPage(page){
      ['menu','schedule','inventory'].forEach(p=>{
        const el = document.getElementById('page-'+p);
        if (el) el.classList.toggle('hidden', p!==page);
      });
      if (page === 'inventory') { refreshInv(); refreshLog(); }
      if (page === 'schedule') { paintWeek(); }
    }
    window.showAppPage = showAppPage;

    // Landing buttons
    $('#go-home').onclick = ()=>{ if (window._authed) { window.showSection('app'); window.showAppPage('menu'); } else { showSection('home'); } };
    $('#cta-learn').onclick = ()=>showSection('about');
    $('#cta-get-started').onclick = ()=>showSection('host');
    $$('a[data-nav]').forEach(a=>a.onclick = (e)=>{ e.preventDefault(); showSection(a.getAttribute('href').substring(1)) });

    const _navMenu = document.getElementById('nav-menu');
    if (_navMenu) _navMenu.onclick = (e)=>{ e.preventDefault(); window.showSection('app'); window.showAppPage('menu'); };

    // Menu buttons
    $('#menu-schedule').onclick = ()=> showAppPage('schedule');
    $('#menu-inventory').onclick = ()=> {
      if (window._role !== 'admin') { alert('Employees cannot access Inventory.'); return; }
      showAppPage('inventory');
    };
    $('#btn-back-schedule').onclick = ()=> showAppPage('menu');
    $('#btn-back-inventory').onclick = ()=> showAppPage('menu');

    // INVENTORY (local only)
    function refreshInv(){
      const inv = store.get(K.inv, []);
      const tbody = $('#inv-table tbody'); if (!tbody) return; tbody.innerHTML='';
      inv.forEach((it, i)=>{
        const val = (it.qty||0) * (it.cost||0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.name}</td><td>${it.sku}</td><td>${it.qty}</td><td>${(it.cost??0).toFixed(2)}</td><td>${val.toFixed(2)}</td>
        <td><button class="btn ghost small" data-edit="${i}">Edit</button>
            <button class="btn secondary small" data-del="${i}">Delete</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('[data-del]').forEach(btn=>{
        btn.onclick = ()=>{ const inv=store.get(K.inv, []); inv.splice(+btn.dataset.del,1); store.set(K.inv, inv); refreshInv(); };
      });
      tbody.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.onclick = ()=>{ const it=store.get(K.inv, [])[+btn.dataset.edit];
          $('#inv-name').value=it.name; $('#inv-sku').value=it.sku; $('#inv-qty').value=it.qty; $('#inv-cost').value=it.cost; };
      });
    }
    function logLine(sku, delta, note=''){ const log = store.get(K.log, []); log.unshift({ts:Date.now(), sku, delta, note}); store.set(K.log, log); refreshLog(); }
    function refreshLog(){
      const tbody = $('#log-table tbody'); if (!tbody) return; tbody.innerHTML='';
      store.get(K.log, []).forEach(row=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${fmtDate(row.ts)}</td><td>${row.sku}</td><td>${row.delta>0?`+${row.delta}`:row.delta}</td><td>${row.note||''}</td>`;
        tbody.appendChild(tr);
      });
    }
    $('#save-item').onclick = ()=>{
      const name=$('#inv-name').value.trim(); const sku=$('#inv-sku').value.trim();
      const qty=+($('#inv-qty').value||0); const cost=parseFloat($('#inv-cost').value||'0');
      if(!name||!sku) return alert('Name and SKU required.');
      const inv=store.get(K.inv, []); const i=inv.findIndex(x=>x.sku===sku);
      if(i>=0){ inv[i]={...inv[i], name, qty, cost}; } else { inv.push({name, sku, qty, cost}); }
      store.set(K.inv, inv); logLine(sku, 0, 'Saved item');
      $('#inv-name').value=$('#inv-sku').value=$('#inv-qty').value=$('#inv-cost').value=''; refreshInv();
    };
    function adjust(sgn){
      const sku=$('#adj-sku').value.trim(); const delta= Math.abs(+($('#adj-delta').value||0))*sgn;
      if(!sku || !delta) return alert('Enter SKU and change amount.');
      const inv=store.get(K.inv, []); const i = inv.findIndex(x=>x.sku===sku);
      if(i<0) return alert('SKU not found.');
      inv[i].qty = (inv[i].qty||0) + delta; store.set(K.inv, inv);
      logLine(sku, delta, sgn>0? 'Receive' : 'Issue'); refreshInv();
    }
    $('#receive').onclick = ()=>adjust(+1);
    $('#issue').onclick = ()=>adjust(-1);

    // Local data import/export
    $('#export-inv').onclick = ()=>{
      const rows = [['Name','SKU','Qty','Unit Cost','Value']];
      store.get(K.inv, []).forEach(it=> rows.push([it.name, it.sku, it.qty, (it.cost??0).toFixed(2), ((it.qty||0)*(it.cost||0)).toFixed(2)]));
      const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='inventory.csv'; a.click();
    };
    $('#wipe').onclick = ()=>{
      if(!confirm('Wipe local inventory data?')) return;
      [K.inv,K.log].forEach(k=>localStorage.removeItem(k));
      location.reload();
    };

    document.getElementById('year').textContent = new Date().getFullYear();
    refreshInv(); refreshLog();
    showSection('home');
  </script>

  <!-- ========= Firebase (Auth + Firestore + email links + verification + notifications + branding) ========= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendEmailVerification,
      sendPasswordResetEmail,
      isSignInWithEmailLink,
      sendSignInLinkToEmail,
      signInWithEmailLink,
      applyActionCode,
      verifyPasswordResetCode,
      confirmPasswordReset,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, addDoc, updateDoc,
      collection, onSnapshot, query, where, serverTimestamp, deleteDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA1kAD-jLJ7UqoTNoDQomI-NhXqusey2Mk",
      authDomain: "artemisskys-81c8d.firebaseapp.com",
      projectId: "artemisskys-81c8d",
      storageBucket: "artemisskys-81c8d.appspot.com",
      messagingSenderId: "1048827230936",
      appId: "1:1048827230936:web:b0e70cce57c867a23635ad",
      measurementId: "G-DY343FNTFS"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch {}
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ORIGIN = window.location.origin;
    const actionCodeSettings = { url: ORIGIN + '/', handleCodeInApp: true };

    const state = {
      profile: null,
      employees: [],
      shifts: [],
      schedScope: 'all',
      brand: null
    };

    // ----- Branding helpers -----
    function applyBrand(brand){
      const name = brand?.brandName || 'Artemis Skys';
      const logo = brand?.brandLogoUrl || '';
      const bg   = brand?.brandBgUrl || (typeof DEFAULT_BG !== 'undefined' ? DEFAULT_BG : '');

      const span = document.getElementById('brand-name'); if (span) span.textContent = name;
      const spanPrev = document.getElementById('brand-name-preview'); if (spanPrev) spanPrev.textContent = name;

      const img = document.getElementById('brand-logo');
      const imgPrev = document.getElementById('brand-logo-preview');
      const fallback = document.getElementById('fallback-logo');
      if (logo) {
        if (img) { img.src = logo; img.style.display='block'; }
        if (imgPrev) { imgPrev.src = logo; imgPrev.style.display='block'; }
        if (fallback) fallback.style.display='none';
      } else {
        if (img) img.style.display='none';
        if (imgPrev) imgPrev.style.display='none';
        if (fallback) fallback.style.display='block';
      }
      // Backgrounds
      try{
        document.body.style.backgroundImage = `linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.35)), url('${bg}')`;
        const sky = document.querySelector('.sky');
        if (sky) sky.style.backgroundImage = `linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.35)), url('${bg}')`;
      }catch{}
    }

    async function saveBranding(){
      if (!orgPath()) return alert('No org available');
      const brandName = (document.getElementById('brand-name-input')?.value || '').trim();
      const brandLogoUrl = (document.getElementById('brand-logo-input')?.value || '').trim();
      const brandBgUrl = (document.getElementById('brand-bg-input')?.value || '').trim();
      const defaultStart = (document.getElementById('brand-default-start')?.value || '09:00').trim();
      const defaultEnd = (document.getElementById('brand-default-end')?.value || '17:00').trim();
      try{
        await setDoc(doc(db, orgPath()), { brandName, brandLogoUrl, brandBgUrl, defaultStart, defaultEnd, updatedAt: serverTimestamp() }, { merge:true });
        alert('Branding saved.');
      }catch(e){ console.warn('branding save failed', e); alert('Could not save branding (rules?).'); }
    }
    document.getElementById('save-brand').onclick = saveBranding;

    // ----- Roles & Org -----
    async function ensureProfile(user){
      try{
        const pRef = doc(db, 'profiles', user.uid);
        const snap = await getDoc(pRef);
        if (!snap.exists()) {
          const profile = { email: user.email, name: user.displayName || user.email, role: 'admin', orgOwner: user.uid, createdAt: serverTimestamp() };
          await setDoc(pRef, profile, {merge:true});
          return profile;
        }
        let prof = snap.data();
        if (!prof.orgOwner) {
          const qy = query(collection(db, 'invites'), where('email','==', user.email), where('status','==','pending'));
          const invs = await getDocs(qy);
          if (!invs.empty) {
            const inv = invs.docs[0]; const {orgOwner,name} = inv.data();
            prof = {...prof, role: 'employee', orgOwner, name: prof.name || name};
            await setDoc(pRef, prof, {merge:true});
            await updateDoc(inv.ref, {status:'used', usedAt: serverTimestamp()});
          }
        }
        return prof;
      }catch(e){
        console.warn('ensureProfile failed (rules?) → using local fallback', e?.message||e);
        return { email: user.email, name: user.displayName || user.email, role: 'admin', orgOwner: user.uid };
      }
    }

    function orgPath(){
      if (!state.profile?.orgOwner) return null;
      return `orgs/${state.profile.orgOwner}`;
    }

    // ----- UI Auth State -----
    const btnLogin = document.getElementById('btn-login');
    const btnSignup = document.getElementById('btn-signup');
    const doLogin  = document.getElementById('do-login');
    const doSignup = document.getElementById('do-signup');
    const btnLogout = document.getElementById('btn-logout');
    const forgotBtn = document.getElementById('forgot-pass');
    const resendBtn = document.getElementById('resend-verify');
    const magicBtn  = document.getElementById('login-magic');

    function setWarn(on, msg){
      const el = document.getElementById('warn');
      if (!el) return;
      el.classList.toggle('hidden', !on);
      if (msg) el.textContent = msg;
    }

    async function refreshAuthUI(){
      const user = auth.currentUser;
      const authed = !!user && !!user.email;
      window._authed = authed;
      const _navMenu = document.getElementById('nav-menu'); if (_navMenu) _navMenu.classList.toggle('hidden', !authed);
      document.getElementById('auth-buttons').classList.toggle('hidden', authed);
      document.getElementById('user-badge').classList.toggle('hidden', !authed);
      if (authed) {
        try{ await user.reload?.(); }catch{}
        const verified = user.emailVerified;
        try{
          state.profile = await ensureProfile(user);
        }catch(e){ setWarn(true, 'Profile load failed. Check Firestore rules.'); }
        document.getElementById('whoami').textContent = `${user.email}${verified ? '' : ' (unverified)'}`;
        const roleTag = (state.profile?.role||'USER').toUpperCase() + ' · ' + user.email;
        document.getElementById('session-user').textContent = roleTag;
        document.getElementById('session-user-sched').textContent = roleTag;
        document.getElementById('session-user-inv').textContent = roleTag;

        const admin = state.profile?.role === 'admin';
        window._role = admin ? 'admin' : 'employee';

        // Menu cards: employees see only scheduling
        document.getElementById('menu-inventory').classList.toggle('hidden', !admin);

        // Show branding panel for admin
        document.getElementById('brand-panel').classList.toggle('hidden', !admin);

        // Default scope for schedule
        state.schedScope = admin ? 'all' : 'mine';
        paintViewTabs();

        // Start listeners
        startOrgListeners();

        // Show the app menu; show verify banner but allow usage
        window.showSection('app');
        window.showAppPage('menu');
        resendBtn.classList.toggle('hidden', verified);
        if (!verified) setWarn(true, 'Your email is not verified yet. You can keep using the app; click “Resend verification” or check your inbox.');
      } else {
        window.showSection('home');
        stopOrgListeners();
      }
    }
    window.refreshAuthUI = refreshAuthUI;

    btnLogin.onclick = ()=>{ window.showSection('auth'); document.getElementById('login-email').focus(); };
    btnSignup.onclick = ()=>{ window.showSection('auth'); document.getElementById('su-name').focus(); };

    // Sign up (admin)
    doSignup.onclick = async () => {
      const name = document.getElementById('su-name').value.trim();
      const email = document.getElementById('su-email').value.trim();
      const pass  = document.getElementById('su-pass').value;
      if(!name || !email || pass.length < 6){ alert('Please fill all fields (password ≥ 6).'); return; }
      try{
        const { user } = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db,'profiles', user.uid), { name, email, role:'admin', orgOwner:user.uid, createdAt: serverTimestamp() }, {merge:true});
        // create org doc so branding can be saved
        await setDoc(doc(db, `orgs/${user.uid}`), { brandName: 'Artemis Skys', createdAt: serverTimestamp() }, { merge:true });
        await sendEmailVerification(user, actionCodeSettings);
        alert('Account created. Check your email for a verification link.');
      }catch(e){ console.error(e); alert(e.message || 'Sign up failed'); }
    };

    
// Login (email/password) with centralized function + Enter key support
window._authReady = true;
window._doLogin = async (emailArg, passArg) => {
  const email = (emailArg ?? document.getElementById('login-email')?.value || '').trim();
  const pass  = (passArg ?? document.getElementById('login-pass')?.value || '');
  if (!email || !pass) { alert('Enter email and password, or use the email link option.'); return; }
  try{
    const { user } = await signInWithEmailAndPassword(auth, email, pass);
    refreshAuthUI();
  }catch(e){
    console.error(e);
    if (String(e?.code||'').includes('operation-not-allowed')) {
      document.getElementById('auth-banner').classList.remove('hidden');
    }
    alert(e.message || 'Login failed');
  }
};

doLogin.onclick = (e) => { e.preventDefault(); window._doLogin(); };

// Bind Enter key in both fields (in case early handler missed it)
['login-email','login-pass'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('keydown', (ev)=>{ if (ev.key === 'Enter'){ ev.preventDefault(); window._doLogin(); } });
});

// If a login was queued before Firebase loaded, execute it now
if (window._pendingLogin) {
  const { email, pass } = window._pendingLogin;
  try { delete window._pendingLogin; } catch {}
  setTimeout(()=> window._doLogin(email, pass), 0);
}


    // Email-link sign-in
    magicBtn.onclick = async () => {
      const email = document.getElementById('login-email').value.trim();
      if(!email) return alert('Enter your email first.');
      try{
        window.localStorage.setItem('as_invite_email', email);
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        alert('Sign-in link sent. Open it from your email on this device.');
      }catch(e){
        console.error(e);
        if (String(e?.code||'').includes('operation-not-allowed')) {
          document.getElementById('auth-banner').classList.remove('hidden');
        }
        alert(e.message || 'Failed to send sign-in link.');
      }
    };

    // Forgot password
    forgotBtn.onclick = async () => {
      const email = document.getElementById('login-email').value.trim();
      if(!email) return alert('Enter your email first.');
      try{
        await sendPasswordResetEmail(auth, email, actionCodeSettings);
        alert('Password reset email sent. Check your inbox.');
      }catch(e){ console.error(e); alert(e.message || 'Failed to send reset email.'); }
    };

    // Resend verification
    resendBtn.onclick = async () => {
      const user = auth.currentUser;
      if(!user) return alert('Please log in first.');
      try{
        await sendEmailVerification(user, actionCodeSettings);
        alert('Verification email sent.');
      }catch(e){ console.error(e); alert(e.message || 'Failed to send verification email.'); }
    };

    // Logout
    btnLogout.onclick = async ()=>{ await signOut(auth); refreshAuthUI(); window.showSection('home'); };

    // ----- Handle incoming email action links -----
    (async () => {
      const href = window.location.href;
      const params = new URLSearchParams(location.search);
      const mode = params.get('mode');
      const oobCode = params.get('oobCode');

      if (isSignInWithEmailLink(auth, href)) {
        let email = window.localStorage.getItem('as_invite_email');
        if (!email) email = prompt('Confirm your email for sign-in:');
        try{
          await signInWithEmailLink(auth, email, href);
          window.localStorage.removeItem('as_invite_email');
          alert('Signed in by email link.');
          history.replaceState({}, '', location.pathname);
          refreshAuthUI();
        }catch(e){ console.error('email-link sign-in failed', e); alert('Sign-in link invalid or expired.'); }
        return;
      }

      if (mode === 'verifyEmail' && oobCode) {
        try { await applyActionCode(auth, oobCode); alert('Email verified!'); }
        catch (e){ console.error('verifyEmail failed', e); alert('Verification link invalid or expired.'); }
        history.replaceState({}, '', location.pathname);
        refreshAuthUI();
        return;
      }

      if (mode === 'resetPassword' && oobCode) {
        try {
          const email = await verifyPasswordResetCode(auth, oobCode);
          document.getElementById('rp-email').textContent = email;
          window._rpCode = oobCode;
          window.showSection('reset');
        } catch (e) {
          console.error('resetPassword link invalid', e);
          alert('Password reset link invalid or expired.');
          history.replaceState({}, '', location.pathname);
          window.showSection('auth');
        }
        return;
      }
    })();

    // Reset password flow
    document.getElementById('rp-cancel').onclick = ()=>{ history.replaceState({}, '', location.pathname); window.showSection('auth'); };
    document.getElementById('rp-submit').onclick = async ()=>{
      const p1 = document.getElementById('rp-pass1').value;
      const p2 = document.getElementById('rp-pass2').value;
      if (p1.length < 6) return alert('Password must be at least 6 characters.');
      if (p1 !== p2)   return alert('Passwords do not match.');
      try {
        await confirmPasswordReset(auth, window._rpCode, p1);
        alert('Password updated. You can now log in.');
        history.replaceState({}, '', location.pathname);
        window.showSection('auth');
      } catch (e) { console.error('confirmPasswordReset failed', e); alert('Could not update password.'); }
    };

    // ----- Firestore listeners -----
    let unsubEmployees = null, unsubShifts = null, unsubBrand = null;
    function stopOrgListeners(){ unsubEmployees?.(); unsubShifts?.(); unsubBrand?.(); }

    function startOrgListeners(){
      stopOrgListeners();
      const base = orgPath(); if (!base) return;

      // Brand doc (org root)
      try{
        const orgRef = doc(db, base);
        unsubBrand = onSnapshot(orgRef, { next:(snap)=>{
          state.brand = snap.exists() ? snap.data() : null;
          applyBrand(state.brand);
          // Populate inputs for admin
          if (window._role === 'admin') {
            document.getElementById('brand-name-input').value = state.brand?.brandName || '';
            document.getElementById('brand-logo-input').value = state.brand?.brandLogoUrl || '';
            document.getElementById('brand-bg-input').value   = state.brand?.brandBgUrl || '';
            const ds = document.getElementById('brand-default-start'); if (ds) ds.value = state.brand?.defaultStart || '09:00';
            const de = document.getElementById('brand-default-end');   if (de) de.value = state.brand?.defaultEnd || '17:00';
          }
        }, error:(err)=>{
          console.warn('brand snapshot error', err);
          applyBrand(null);
        }});
      }catch(e){ console.warn('Brand listener failed:', e); }

      // Employees
      try{
        const empCol = collection(db, `${base}/employees`);
        unsubEmployees = onSnapshot(empCol, { next:(snap)=>{
          state.employees = snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>a.name?.localeCompare?.(b.name||'')||0);
          paintEmployees();
          paintShiftOptions();
          paintWeek();
          const me = auth.currentUser?.email?.toLowerCase();
          const mine = state.employees.find(e => (e.email||'').toLowerCase() === (me||''));
          const cb = document.getElementById('me-subscribed'); if (cb) cb.checked = !!mine?.subscribed;
        }, error:(err)=>{
          console.warn('employees snapshot error', err);
          setWarn(true, 'Cannot read employees. Check Firestore rules.');
        }});
      }catch(e){ setWarn(true, 'Employees listener failed.'); }

      // Shifts
      try{
        const shCol = collection(db, `${base}/shifts`);
        unsubShifts = onSnapshot(shCol, { next:(snap)=>{
          state.shifts = snap.docs.map(d=>({id:d.id, ...d.data()}));
          paintWeek();
        }, error:(err)=>{
          console.warn('shifts snapshot error', err);
          setWarn(true, 'Cannot read shifts. Check Firestore rules.');
        }});
      }catch(e){ setWarn(true, 'Shifts listener failed.'); }
    }

    // ----- Admin: manage employees & invites -----
    async function addEmployeeRow({name,email, subscribed=true}){
      const base = orgPath(); if (!base) return alert('No org');
      const id = (email || name || crypto.randomUUID()).toLowerCase();
      await setDoc(doc(db, `${base}/employees/${id}`), {
        name: name || email, email: email || null, subscribed: !!subscribed, createdAt: serverTimestamp()
      }, {merge:true});
    }

    document.getElementById('add-emp').onclick = async ()=>{
      const name = document.getElementById('emp-name').value.trim();
      const email = document.getElementById('emp-email').value.trim();
      if (!name && !email) return alert('Provide a name or email.');
      try{
        await addEmployeeRow({name,email,subscribed:true});
        document.getElementById('emp-name').value=''; document.getElementById('emp-email').value='';
      }catch(e){ setWarn(true, 'Add employee failed (rules?)'); }
    };

    document.getElementById('invite-emp').onclick = async ()=>{
      const name = document.getElementById('emp-name').value.trim();
      const email = document.getElementById('emp-email').value.trim();
      if (!email) return alert('Employee email required.');
      const base = orgPath(); if (!base) return alert('No org');
      try{
        await addEmployeeRow({name,email,subscribed:true});
        await addDoc(collection(db, 'invites'), { orgOwner: state.profile.orgOwner, email, name: name || email, status:'pending', createdAt: serverTimestamp() });
        window.localStorage.setItem('as_invite_email', email);
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        alert('Invite sent. Ask them to open the link from their email.');
        document.getElementById('emp-name').value=''; document.getElementById('emp-email').value='';
      }catch(e){ console.error(e); setWarn(true, 'Invite failed. Check Auth (Email Link) + Authorized domains.'); alert(e.message || 'Failed to send invite.'); }
    };

    function paintEmployees(){
      const tbody = document.querySelector('#emp-table tbody');
      if (!tbody) return;
      const admin = state.profile?.role==='admin';
      tbody.innerHTML='';
      state.employees.forEach(e=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.name||''}</td>
          <td>${e.email||''}</td>
          <td>${admin
              ? `<input type="checkbox" data-sub="${e.id}" ${e.subscribed?'checked':''}/>`
              : `${e.subscribed ? 'Yes':'No'}`}</td>
          <td>${admin ? `<button class="btn ghost small" data-del="${e.id}">Remove</button>` : ''}</td>`;
        tbody.appendChild(tr);
      });
      if (state.profile?.role==='admin') {
        tbody.querySelectorAll('[data-sub]').forEach(el=>{
          el.onchange = async ()=>{
            const id = el.getAttribute('data-sub');
            try{ await updateDoc(doc(db, `${orgPath()}/employees/${id}`), {subscribed: el.checked}); }
            catch(e){ setWarn(true, 'Update failed (rules?)'); }
          };
        });
        tbody.querySelectorAll('[data-del]').forEach(btn=>{
          btn.onclick = async ()=>{
            if (!confirm('Remove this employee?')) return;
            try{ await deleteDoc(doc(db, `${orgPath()}/employees/${btn.getAttribute('data-del')}`)); }
            catch(e){ setWarn(true, 'Delete failed (rules?)'); }
          };
        });
      }
      const meToggle = document.getElementById('me-subscribed');
      if (meToggle) {
        meToggle.onchange = async ()=>{
          const me = auth.currentUser?.email?.toLowerCase();
          const mine = state.employees.find(x=> (x.email||'').toLowerCase() === (me||''));
          if (mine) {
            try{ await updateDoc(doc(db, `${orgPath()}/employees/${mine.id}`), {subscribed: meToggle.checked}); }
            catch(e){ setWarn(true, 'Preference save failed.'); }
          } else alert('Ask your admin to add your email to the employee list.');
        };
      }
    }

    // ----- Schedule view (My vs All) -----
    function paintViewTabs(){
      const tabs = document.querySelectorAll('#view-tabs .tab');
      tabs.forEach(t=>{
        t.classList.toggle('active', t.dataset.scope === state.schedScope);
        t.onclick = ()=>{ state.schedScope = t.dataset.scope; paintViewTabs(); paintWeek(); };
        // Employees cannot view ALL unless there are no name matches (fallback to all names)
        if (window._role !== 'admin') {
          if (t.dataset.scope === 'all') t.style.display = 'none';
        } else {
          if (t.dataset.scope === 'all') t.style.display = '';
        }
      });
    }

    function paintShiftOptions(){
      const sel = document.getElementById('shift-emp'); if (!sel) return;
      sel.innerHTML='';
      state.employees.forEach(e=>{
        const o=document.createElement('option'); o.value=e.name; o.textContent=e.name + (e.email ? ` (${e.email})`: '');
        sel.appendChild(o);
      });
    }

    document.getElementById('add-shift').onclick = async ()=>{
      if (state.profile?.role!=='admin') return alert('Only admins can add shifts.');
      const base = orgPath(); if (!base) return alert('No org');
      const date=document.getElementById('shift-date').value || new Date().toISOString().slice(0,10);
      const emp=document.getElementById('shift-emp').value;
      const start=document.getElementById('shift-start').value;
      const end=document.getElementById('shift-end').value;
      const shouldEmail=document.getElementById('shift-email-update').checked;
      if(!emp||!start||!end) return alert('Pick employee, start and end time.');
      try{
        await addDoc(collection(db, `${base}/shifts`), {date, empName:emp, start, end, createdAt: serverTimestamp(), updatedAt: serverTimestamp()});
        if (shouldEmail) await emailShiftNotice({date, empName: emp, start, end});
        alert('Shift added.');
      }catch(e){ console.error(e); setWarn(true, 'Add shift failed (rules?)'); }
    };

    document.getElementById('refresh-week').onclick = paintWeek;
    const wsi = document.getElementById('week-start'); if (wsi) wsi.value = weekStartISO();

    
function paintWeek(){
      const startInput = document.getElementById('week-start');
      if (!startInput) return;
      const start = new Date(startInput.value || weekStartISO());
      const days = [...Array(7)].map((_,i)=>{ const d=new Date(start); d.setDate(d.getDate()+i); return d; });
      const head = document.getElementById('week-head'); head.innerHTML='';
      const htr = document.createElement('tr');
      htr.innerHTML = '<th>Employee</th>' + days.map(d=>`<th>${d.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'})}</th>`).join('');
      head.appendChild(htr);

      const body = document.getElementById('week-body'); body.innerHTML='';

      const admin = window._role === 'admin';
      const meEmail = (auth.currentUser?.email||'').toLowerCase();
      const myNames = state.employees.filter(e=> (e.email||'').toLowerCase()===meEmail).map(e=>e.name).filter(Boolean);
      const allNames = [...new Set(state.employees.map(e=>e.name).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
      const names = (state.schedScope==='mine' && myNames.length) ? myNames : (admin ? allNames : myNames.length ? myNames : allNames);

      names.forEach(name=>{
        const tr = document.createElement('tr');
        const tds = days.map(d=>{
          const iso = d.toISOString().slice(0,10);
          const list = state.shifts.filter(s=>s.empName===name && s.date===iso);
          const items = list.map(s=>`
            <div class="row" style="gap:6px; align-items:center">
              <span>${s.start}–${s.end}</span>
              ${admin ? `<button class="btn secondary small shift-edit" data-id="${s.id}" data-name="${name}" data-date="${iso}" data-start="${s.start}" data-end="${s.end}" title="Edit">✎</button>
                         <button class="btn ghost small shift-del" data-id="${s.id}" title="Remove">×</button>` : ''}
            </div>
          `).join('');
          const addBtn = admin ? `<div style="margin-top:6px"><button class="btn ghost small shift-add" data-name="${name}" data-date="${iso}">+ Add</button></div>` : '';
          return `<td>${items}${addBtn}</td>`;
        });
        tr.innerHTML = `<td><strong>${name}</strong></td>` + tds.join('');
        body.appendChild(tr);
      });

      // Wire up admin actions
      if (admin) {
        const base = orgPath();
        // Add
        body.querySelectorAll('.shift-add').forEach(btn=>{
          btn.onclick = async ()=>{
            const empName = btn.getAttribute('data-name');
            const date = btn.getAttribute('data-date');
            const defStart = state.brand?.defaultStart || '09:00';
            const defEnd = state.brand?.defaultEnd || '17:00';
            try{
              await addDoc(collection(db, `${base}/shifts`), {date, empName, start:defStart, end:defEnd, createdAt: serverTimestamp(), updatedAt: serverTimestamp()});
              paintWeek();
            }catch(e){ console.warn('quick add failed', e); setWarn(true, 'Add shift failed (rules?)'); }
          };
        });
        // Delete
        body.querySelectorAll('.shift-del').forEach(btn=>{
          btn.onclick = async ()=>{
            const id = btn.getAttribute('data-id');
            if (!confirm('Remove this shift?')) return;
            try{ await deleteDoc(doc(db, `${base}/shifts/${id}`)); paintWeek(); }
            catch(e){ console.warn('delete failed', e); setWarn(true, 'Delete failed (rules?)'); }
          };
        });
        // Edit (change times and/or reassign)
        body.querySelectorAll('.shift-edit').forEach(btn=>{
          btn.onclick = async ()=>{
            const id = btn.getAttribute('data-id');
            const curName = btn.getAttribute('data-name');
            const curDate = btn.getAttribute('data-date');
            const curStart = btn.getAttribute('data-start');
            const curEnd = btn.getAttribute('data-end');
            const newStart = prompt('Start time (HH:MM)', curStart) || curStart;
            const newEnd = prompt('End time (HH:MM)', curEnd) || curEnd;
            let newName = curName;
            if (confirm('Reassign to a different employee?')) {
              const list = [...new Set(state.employees.map(e=>e.name).filter(Boolean))].join(', ');
              const typed = prompt('Type a name exactly as listed:
' + list, curName);
              if (typed) newName = typed;
            }
            try{
              await updateDoc(doc(db, `${base}/shifts/${id}`), { empName: newName, start: newStart, end: newEnd, updatedAt: serverTimestamp() });
              paintWeek();
            }catch(e){ console.warn('edit failed', e); setWarn(true, 'Edit failed (rules?)'); }
          };
        });
      }
    }

    // ----- Email notifications
 (via Trigger Email extension) -----
    async function emailShiftNotice(shift){
      try{
        const to = state.employees.filter(e=>e.subscribed && e.email).map(e=>e.email);
        if (to.length===0) return;
        const subject = `New shift posted: ${shift.empName} on ${shift.date}`;
        const text = `A new shift was added.\n\nWhen: ${shift.date} ${shift.start}–${shift.end}\nWho: ${shift.empName}\n\n— Artemis Skys`;
        const html = `
          <div style="font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial">
            <h3>New shift posted</h3>
            <p><strong>When:</strong> ${shift.date} ${shift.start}–${shift.end}</p>
            <p><strong>Who:</strong> ${shift.empName}</p>
            <p style="color:#555">— Artemis Skys</p>
          </div>`;
        await addDoc(collection(db, 'mail'), { to, message: { subject, text, html } });
      }catch(e){ console.warn('Email send skipped/failed:', e?.message||e); }
    }

    onAuthStateChanged(auth, ()=>{ refreshAuthUI(); });
  </script>

  <!--
  ===== Firestore Security Rules (update your console) =====

  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /profiles/{uid} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
      match /invites/{inviteId} {
        allow create: if request.auth != null;
        allow read, update, delete: if false;
      }
      match /orgs/{orgOwner} {
        allow read: if request.auth != null && (
          request.auth.uid == orgOwner ||
          (exists(/databases/$(database)/documents/profiles/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.orgOwner == orgOwner)
        );
        allow write: if request.auth != null && request.auth.uid == orgOwner; // allow admin to update branding

        match /employees/{empId} {
          allow read: if true;
          allow create, update, delete: if request.auth != null && request.auth.uid == orgOwner;
        }
        match /shifts/{shiftId} {
          allow read: if true;
          allow create, update, delete: if request.auth != null && request.auth.uid == orgOwner;
        }
      }
      match /mail/{docId} {
        allow create: if request.auth != null &&
          exists(/databases/$(database)/documents/profiles/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
        allow read, update, delete: if false;
      }
    }
  }
  -->
</body>
</html>
